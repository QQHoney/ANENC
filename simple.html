<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰èƒ½ç‰©æµå†œåœº - ç®€åŒ–æµ‹è¯•ç‰ˆ</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 400px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button { width: 100%; padding: 12px; background: #FF6B00; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px 0; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin: 10px 0; box-sizing: border-box; }
        .branch-select { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .branch-btn { padding: 10px; background: #e0e0e0; border: 2px solid transparent; border-radius: 6px; cursor: pointer; }
        .branch-btn.selected { background: #FFE0B2; border-color: #FF6B00; }
        .hidden { display: none; }
        .success { color: #2e7d32; }
        .error { color: #c62828; }
        .info { color: #1565c0; }
        #station { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0; }
        .slot { aspect-ratio: 1; background: #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px dashed #999; }
        .slot.has-cargo { border-style: solid; background: #fff; }
        .slot.ready { background: #C8E6C9; border-color: #4CAF50; }
        .cargo-item { padding: 10px; background: #f9f9f9; border-radius: 6px; margin: 5px 0; cursor: pointer; }
        .cargo-item:hover { background: #e3f2fd; }
        .log { background: #f0f0f0; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2 style="text-align: center;">ğŸšš å®‰èƒ½ç‰©æµå†œåœº</h2>

    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-view" class="card">
        <h3>å¼€å§‹æ¸¸æˆ</h3>
        <input type="text" id="nickname" placeholder="è¾“å…¥æ˜µç§°" maxlength="12">
        <button onclick="goToBranch()">é€‰æ‹©åˆ†æ‹¨</button>
    </div>

    <!-- åˆ†æ‹¨é€‰æ‹© -->
    <div id="branch-view" class="card hidden">
        <h3>é€‰æ‹©åˆ†æ‹¨</h3>
        <div class="branch-select" id="branch-list"></div>
        <button onclick="register()">ç¡®è®¤æ³¨å†Œ</button>
        <button onclick="backToLogin()" style="background: #666;">è¿”å›</button>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-view" class="card hidden">
        <h3 id="user-info">ç”¨æˆ·ä¿¡æ¯</h3>
        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>ğŸ’° <span id="coins">0</span></span>
            <span>ğŸ’ <span id="diamonds">0</span></span>
            <span>â­ Lv.<span id="level">1</span></span>
        </div>

        <h4>æˆ‘çš„ç«™åœº</h4>
        <div id="station"></div>

        <div style="margin-top: 15px;">
            <button onclick="harvestAll()">ä¸€é”®æ”¶å–</button>
            <button onclick="logout()" style="background: #666;">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- è°ƒè¯•æ—¥å¿— -->
    <div class="card">
        <h4>è°ƒè¯•æ—¥å¿—</h4>
        <div id="log" class="log">å‡†å¤‡å°±ç»ª...</div>
        <button onclick="clearLog()" style="background: #999; margin-top: 5px;">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>

    <script>
        let currentUser = null;
        let selectedBranch = null;
        let tempNickname = null;

        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#c62828' : type === 'success' ? '#2e7d32' : '#1565c0';
            logDiv.innerHTML += `[${time}] ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function showView(viewId) {
            ['login-view', 'branch-view', 'game-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        function goToBranch() {
            const nickname = document.getElementById('nickname').value.trim();
            if (!nickname) {
                log('è¯·è¾“å…¥æ˜µç§°', 'error');
                return;
            }
            if (nickname.length < 2 || nickname.length > 12) {
                log('æ˜µç§°é•¿åº¦2-12ä¸ªå­—ç¬¦', 'error');
                return;
            }

            tempNickname = nickname;

            // åŠ è½½åˆ†æ‹¨åˆ—è¡¨
            const branchList = document.getElementById('branch-list');
            branchList.innerHTML = '';
            CONFIG.branches.forEach(branch => {
                const btn = document.createElement('div');
                btn.className = 'branch-btn';
                btn.textContent = branch.name;
                btn.onclick = () => {
                    document.querySelectorAll('.branch-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedBranch = branch.id;
                    log(`é€‰æ‹©äº†: ${branch.name}`, 'success');
                };
                branchList.appendChild(btn);
            });

            showView('branch-view');
            log('è¯·é€‰æ‹©åˆ†æ‹¨', 'info');
        }

        function backToLogin() {
            showView('login-view');
        }

        async function register() {
            if (!selectedBranch) {
                log('è¯·é€‰æ‹©åˆ†æ‹¨', 'error');
                return;
            }

            log('æ­£åœ¨æ³¨å†Œ...', 'info');

            try {
                const result = await userApi.register({
                    nickname: tempNickname,
                    branchId: selectedBranch
                });

                if (result.success) {
                    currentUser = result.data;
                    log(`æ³¨å†ŒæˆåŠŸ! ç”¨æˆ·ID: ${currentUser.userId}`, 'success');
                    log(`è·å¾—æ–°æ‰‹ç¤¼åŒ…: ${currentUser.coins}é‡‘å¸, ${currentUser.diamonds}é’»çŸ³`, 'success');

                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                    document.getElementById('user-info').textContent = `${currentUser.nickname} - ${currentUser.branchName}`;
                    document.getElementById('coins').textContent = currentUser.coins;
                    document.getElementById('diamonds').textContent = currentUser.diamonds;
                    document.getElementById('level').textContent = currentUser.level;

                    // åŠ è½½ç«™åœº
                    await loadStation();
                    showView('game-view');
                } else {
                    log('æ³¨å†Œå¤±è´¥: ' + result.message, 'error');
                }
            } catch (e) {
                log('æ³¨å†Œé”™è¯¯: ' + e.message, 'error');
                console.error(e);
            }
        }

        async function loadStation() {
            if (!currentUser) return;

            try {
                const result = await stationApi.getStationCargos(currentUser.userId);
                if (result.success) {
                    const cargos = result.data;
                    const station = document.getElementById('station');
                    station.innerHTML = '';

                    const slotCount = currentUser.stationSlots;
                    const now = Date.now();

                    for (let i = 0; i < slotCount; i++) {
                        const slot = document.createElement('div');
                        slot.className = 'slot';
                        const cargo = cargos.find(c => c.slotIndex === i);

                        if (cargo) {
                            slot.classList.add('has-cargo');
                            const elapsed = now - cargo.startTime;
                            const remain = Math.max(0, cargo.growTime - elapsed);
                            const isReady = remain <= 0;

                            if (isReady) {
                                slot.classList.add('ready');
                                slot.textContent = 'âœ…';
                            } else {
                                slot.textContent = cargo.typeName.substring(0, 2);
                            }

                            slot.onclick = () => {
                                if (isReady) {
                                    harvestCargo(cargo.id);
                                } else {
                                    log(`${cargo.typeName} è¿˜åœ¨å¤„ç†ä¸­...`, 'info');
                                }
                            };
                        } else {
                            slot.textContent = '+';
                            slot.onclick = () => placeCargo(i);
                        }

                        station.appendChild(slot);
                    }

                    log(`åŠ è½½äº† ${cargos.length} ä¸ªè´§ç‰©`, 'success');
                }
            } catch (e) {
                log('åŠ è½½ç«™åœºé”™è¯¯: ' + e.message, 'error');
            }
        }

        async function placeCargo(slotIndex) {
            // æ˜¾ç¤ºè´§ç‰©é€‰æ‹©
            const cargoType = CONFIG.cargoTypes[0]; // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
            log(`æ”¾ç½® ${cargoType.name}...`, 'info');

            try {
                const result = await stationApi.placeCargo(currentUser.userId, slotIndex, cargoType.id);
                if (result.success) {
                    log('æ”¾ç½®æˆåŠŸ!', 'success');
                    await loadStation();
                } else {
                    log('æ”¾ç½®å¤±è´¥: ' + result.message, 'error');
                }
            } catch (e) {
                log('æ”¾ç½®é”™è¯¯: ' + e.message, 'error');
            }
        }

        async function harvestCargo(cargoId) {
            log('æ”¶å–è´§ç‰©...', 'info');

            try {
                const result = await stationApi.harvestCargo(currentUser.userId, cargoId);
                if (result.success) {
                    log(`æ”¶å–æˆåŠŸ! è·å¾— ${result.data.coins} é‡‘å¸`, 'success');

                    // å¢åŠ ç»éªŒ
                    await userApi.addExp(currentUser.userId, result.data.exp);

                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                    currentUser = Storage.getUserInfo();
                    document.getElementById('coins').textContent = currentUser.coins;
                    document.getElementById('diamonds').textContent = currentUser.diamonds;
                    document.getElementById('level').textContent = currentUser.level;

                    await loadStation();
                } else {
                    log('æ”¶å–å¤±è´¥: ' + result.message, 'error');
                }
            } catch (e) {
                log('æ”¶å–é”™è¯¯: ' + e.message, 'error');
            }
        }

        async function harvestAll() {
            if (!currentUser) return;

            try {
                const result = await stationApi.getStationCargos(currentUser.userId);
                if (!result.success) return;

                const now = Date.now();
                const readyCargos = result.data.filter(c => now - c.startTime >= c.growTime);

                if (readyCargos.length === 0) {
                    log('æ²¡æœ‰å¯æ”¶å–çš„è´§ç‰©', 'info');
                    return;
                }

                log(`æ­£åœ¨æ”¶å– ${readyCargos.length} ä¸ªè´§ç‰©...`, 'info');

                let totalCoins = 0;
                let totalExp = 0;

                for (const cargo of readyCargos) {
                    const harvestResult = await stationApi.harvestCargo(currentUser.userId, cargo.id);
                    if (harvestResult.success) {
                        totalCoins += harvestResult.data.coins;
                        totalExp += harvestResult.data.exp;
                    }
                }

                if (totalExp > 0) {
                    await userApi.addExp(currentUser.userId, totalExp);
                }

                log(`æ”¶å–å®Œæˆ! è·å¾— ${totalCoins} é‡‘å¸`, 'success');

                currentUser = Storage.getUserInfo();
                document.getElementById('coins').textContent = currentUser.coins;
                document.getElementById('diamonds').textContent = currentUser.diamonds;
                document.getElementById('level').textContent = currentUser.level;

                await loadStation();
            } catch (e) {
                log('ä¸€é”®æ”¶å–é”™è¯¯: ' + e.message, 'error');
            }
        }

        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
                Storage.removeUserInfo();
                currentUser = null;
                selectedBranch = null;
                tempNickname = null;
                showView('login-view');
                log('å·²é€€å‡ºç™»å½•', 'info');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰å·²ç™»å½•ç”¨æˆ·
        window.addEventListener('load', () => {
            const stored = Storage.getUserInfo();
            if (stored) {
                log('å‘ç°å·²ç™»å½•ç”¨æˆ·: ' + stored.nickname, 'success');
                currentUser = stored;
                document.getElementById('user-info').textContent = `${stored.nickname} - ${stored.branchName}`;
                document.getElementById('coins').textContent = stored.coins;
                document.getElementById('diamonds').textContent = stored.diamonds;
                document.getElementById('level').textContent = stored.level;
                loadStation();
                showView('game-view');
            } else {
                log('è¯·å…ˆæ³¨å†Œå¼€å§‹æ¸¸æˆ', 'info');
            }
        });
    </script>
</body>
</html>
